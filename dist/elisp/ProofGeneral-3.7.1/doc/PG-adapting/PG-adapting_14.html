<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html401/loose.dtd">
<html>
<!-- Created on July, 24 2008 by texi2html 1.78 -->
<!--
Written by: Lionel Cons <Lionel.Cons@cern.ch> (original author)
            Karl Berry  <karl@freefriends.org>
            Olaf Bachmann <obachman@mathematik.uni-kl.de>
            and many others.
Maintained by: Many creative people.
Send bugs and suggestions to <texi2html-bug@nongnu.org>

-->
<head>
<title>Adapting Proof General: 13. Internals of Proof General</title>

<meta name="description" content="Adapting Proof General: 13. Internals of Proof General">
<meta name="keywords" content="Adapting Proof General: 13. Internals of Proof General">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="texi2html 1.78">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
pre.display {font-family: serif}
pre.format {font-family: serif}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: serif; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: serif; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.roman {font-family:serif; font-weight:normal;}
span.sansserif {font-family:sans-serif; font-weight:normal;}
ul.toc {list-style: none}
-->
</style>


</head>

<body lang="en" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#800080" alink="#FF0000">

<a name="Internals-of-Proof-General"></a>
<a name="SEC40"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="PG-adapting_13.html#SEC39" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC41" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting_13.html#SEC35" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h1 class="chapter"> 13. Internals of Proof General </h1>

<p>This chapter sketches some of the internal functions and variables of
Proof General, to help developers who wish to understand or modify the
code.
</p>
<p>Most of the documentation below is generated automatically from the
comments in the code.  Because Emacs lisp is interpreted and
self-documenting, the best way to find your way around the source is
inside Emacs once Proof General is loaded.  Read the source files, and
use functions such as <kbd>C-h v</kbd> and <kbd>C-h f</kbd>.
</p>
<p>The code is split into files.  The following sections document the
important files, kept in the &lsquo;<tt>generic/</tt>&rsquo; subdirectory.
</p>
<table class="menu" border="0" cellspacing="0">
<tr><td align="left" valign="top"><a href="#SEC41">13.1 Spans</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">                       
</td></tr>
<tr><td align="left" valign="top"><a href="#SEC43">13.3 Configuration variable mechanisms</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
<tr><td align="left" valign="top"><a href="#SEC42">13.2 Proof General site configuration</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">  
</td></tr>
<tr><td align="left" valign="top"><a href="#SEC44">13.4 Global variables</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#SEC45">13.5 Proof script mode</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">           
</td></tr>
<tr><td align="left" valign="top"><a href="#SEC46">13.6 Proof shell mode</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">            
</td></tr>
<tr><td align="left" valign="top"><a href="#SEC49">13.7 Debugging</a></td><td>&nbsp;&nbsp;</td><td align="left" valign="top">
</td></tr>
</table>



<hr size="6">
<a name="Spans"></a>
<a name="SEC41"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC40" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC42" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC40" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 13.1 Spans </h2>

<p><em>Spans</em> are an abstraction of XEmacs <em>extents</em> used to help
bridge the gulf between GNU Emacs and XEmacs.  In GNU Emacs, spans are
implemented using <em>overlays</em>.
</p>
<p>See the files &lsquo;<tt>span-extent.el</tt>&rsquo; and &lsquo;<tt>span-overlay.el</tt>&rsquo; for the
implementation of the common interface in each case.
</p>
<hr size="6">
<a name="Proof-General-site-configuration"></a>
<a name="SEC42"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC41" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC43" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC40" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 13.2 Proof General site configuration </h2>

<p>The file &lsquo;<tt>proof-site.el</tt>&rsquo; contains the initial configuration for
Proof General for the site (or user) and the choice of provers.
</p>
<p>The first part of the configuration is to set
<code>proof-home-directory</code> to the directory that &lsquo;<tt>proof-site.el</tt>&rsquo;
is located in, or to the variable of the environment variable
<code>PROOFGENERAL_HOME</code> if that is set.
</p>
<dl>
<dt><u>Variable:</u> <b>proof-home-directory</b>
<a name="IDX145"></a>
</dt>
<dd><p>Directory where Proof General is installed.  Ends with slash.<br>
Default value taken from environment variable &lsquo;<samp>PROOFGENERAL_HOME</samp>&rsquo; if set, 
otherwise based on where the file &lsquo;<samp>proof-site.el</samp>&rsquo; was loaded from.
You can use customize to set this variable.
</p></dd></dl>


<p>Further directory variables allow the files of Proof General to be split
up and installed across a system if need be, rather than under the
<code>proof-home-directory</code> root.
</p>
<dl>
<dt><u>Variable:</u> <b>proof-images-directory</b>
<a name="IDX146"></a>
</dt>
<dd><p>Where Proof General image files are installed.  Ends with slash.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-info-directory</b>
<a name="IDX147"></a>
</dt>
<dd><p>Where Proof General Info files are installed.  Ends with slash.
</p></dd></dl>



<a name="IDX148"></a>
<p>After defining these settings, we define a <em>mode stub</em> for each
proof assistant enabled.  The mode stub will autoload Proof General for
the right proof assistant when a file is visited with the corresponding
extension.  The proof assistants enabled are the ones listed
in the <code>proof-assistants</code> setting.
</p>
<dl>
<dt><u>User Option:</u> <b>proof-assistants</b>
<a name="IDX149"></a>
</dt>
<dd><p>Choice of proof assistants to use with Proof General.<br>
A list of symbols chosen from: <code>'isar</code> <code>'coq</code> <code>'phox</code> <code>'lego</code> <code>'plastic</code>.
If nil, the default will be ALL available proof assistants.
</p>
<p>Each proof assistant defines its own instance of Proof General,
providing session control, script management, etc.  Proof General
will be started automatically for the assistants chosen here.
To avoid accidently invoking a proof assistant you don't have,
only select the proof assistants you (or your site) may need.
</p>
<p>You can select which proof assistants you want by setting this
variable before &lsquo;<samp>proof-site.el</samp>&rsquo; is loaded, or by setting
the environment variable &lsquo;<samp>PROOFGENERAL_ASSISTANTS</samp>&rsquo; to the
symbols you want, for example &quot;lego isa&quot;.  Or you can
edit the file &lsquo;<samp>proof-site.el</samp>&rsquo; itself.
</p>
<p>Note: to change proof assistant, you must start a new Emacs session.
</p>
<p>The default value is <code>nil</code>.
</p></dd></dl>

<p>The file &lsquo;<tt>proof-site.el</tt>&rsquo; also defines a version variable.
</p>
<dl>
<dt><u>Variable:</u> <b>proof-general-version</b>
<a name="IDX150"></a>
</dt>
<dd><p>Version string identifying Proof General release.
</p></dd></dl>



<hr size="6">
<a name="Configuration-variable-mechanisms"></a>
<a name="SEC43"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC42" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC44" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC40" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 13.3 Configuration variable mechanisms </h2>

<p>The file &lsquo;<tt>proof-config.el</tt>&rsquo; defines the configuration variables for
Proof General, including instantiation parameters and user options.  See
previous chapters for details of its contents.  Here we mention some
conventions for declaring user options.
</p>
<p>Global user options and instantiation parameters are declared using
<code>defcustom</code> as usual.  User options should have `<code>*</code>' as the
first character of their docstrings (standard Emacs convention) and live
in the customize group <code>proof-user-options</code>.  See
&lsquo;<tt>proof-config.el</tt>&rsquo; for the groups for instantiation parameters.
</p>
<p>User options which are generic (having separate instances for each
prover) and instantiation parameters (by definition generic) can be
declared using the special macro <code>defpgcustom</code>.  It is used in the
same way as <code>defcustom</code>, except that the symbol declared will
automatically be prefixed by the current proof assistant symbol.
</p>
<dl>
<dt><u>Macro:</u> <b>defpgcustom</b>
<a name="IDX151"></a>
</dt>
<dd><p>Define a new customization variable &lt;PA&gt;<var>-sym</var> for the current proof assistant.<br>
The function proof-assistant-&lt;SYM&gt; is also defined, which can be used in the
generic portion of Proof General to set and retrieve the value for the current p.a.
Arguments as for &lsquo;<samp>defcustom</samp>&rsquo;, which see.
</p>
<p>Usage: (defpgcustom SYM &amp;rest <var>args</var>).
</p></dd></dl>

<p>In specific instances of Proof General, the macro <code>defpgdefault</code>
can be used to give a default value for a generic setting.
</p>
<dl>
<dt><u>Macro:</u> <b>defpgdefault</b>
<a name="IDX152"></a>
</dt>
<dd><p>Set default for the proof assistant specific variable &lt;PA&gt;<var>-sym</var> to <var>value</var>.<br>
This should be used in prover-specific code to alter the default values
for prover specific settings.
</p>
<p>Usage: (defpgdefault SYM <var>value</var>)
</p></dd></dl>

<p>All new instantiation variables are best declared using the
<code>defpgcustom</code> mechanism (old code may be converted gradually).
Customizations which are liable to be different for different instances
of Proof General are also best declared in this way.  An example is the
use of X Symbol, controlled by <code><em>PA</em>-x-symbol-enable</code>, since
it works poorly or not at all with some provers.
</p>
<p>To access the generic settings, the following four functions and
macros are useful.
</p>
<dl>
<dt><u>Macro:</u> <b>proof-ass</b>
<a name="IDX153"></a>
</dt>
<dd><p>Return the value for SYM for the current prover.<br>
This macro should only be invoked once a specific prover is engaged.
</p></dd></dl>
<dl>
<dt><u>Macro:</u> <b>proof-ass-sym</b>
<a name="IDX154"></a>
</dt>
<dd><p>Return the symbol for SYM for the current prover.  SYM not evaluated.<br>
This macro should only be called once a specific prover is known.
</p></dd></dl>
<dl>
<dt><u>Macro:</u> <b>proof-ass-symv</b>
<a name="IDX155"></a>
</dt>
<dd><p>Return the symbol for SYM for the current prover.  SYM evaluated.<br>
This macro should only be invoked once a specific prover is engaged.
</p></dd></dl>

<p>If changing a user option setting amounts to more than just setting a
variable (it may have some dynamic effect), we can set the
<code>custom-set</code> property for the variable to the function
<code>proof-set-value</code> which does an ordinary <code>set-default</code> to set
the variable, and then calls a function with the same name as the
variable, to do whatever is necessary according to the new value for the
variable.  
</p>
<p>There are several settings which can be switched on or off by the user,
which use this <code>proof-set-value</code> mechanism.  They are controlled by
boolean variables with names like <code>proof-<var>foo</var>-enable</code>, and
appear at the start of the customize group <code>proof-user-options</code>.
They should be edited by the user through the customization mechanism,
and set in the code using <code>customize-set-variable</code>.
</p>
<p>In <code>proof-utils.el</code> there is a handy macro,
<code>proof-deftoggle</code>, which constructs an interactive function
for toggling boolean customize settings.  We can use this to make an
interactive function <code>proof-<var>foo</var>-toggle</code> to put on a menu or
bind to a key, for example.
</p>
<p>This general scheme is followed as far as possible, to give uniform
behaviour and appearance for boolean user options, as well as
interfacing properly with the <code>customize</code> mechanism.
</p>
<dl>
<dt><u>Function:</u> <b>proof-set-value</b><i> sym value</i>
<a name="IDX156"></a>
</dt>
<dd><p>Set a customize variable using <code>set-default</code> and a function.<br>
We first call &lsquo;<samp><code>set-default</code></samp>&rsquo; to set <var>sym</var> to <var>value</var>.
Then if there is a function <var>sym</var> (i.e. with the same name as the
variable <var>sym</var>), it is called to take some dynamic action for the new
setting.
</p>
<p>If there is no function <var>sym</var>, we try stripping
<code>proof-assistant-symbol</code> and adding &quot;proof-&quot; instead to get
a function name.  This extends <code>proof-set-value</code> to work with
generic individual settings.
</p>
<p>The dynamic action call only happens when values <strong>change</strong>: as an
approximation we test whether proof-config is fully-loaded yet.
</p></dd></dl>

<dl>
<dt><u>Macro:</u> <b>proof-deftoggle</b>
<a name="IDX157"></a>
</dt>
<dd><p>Define a function VAR-toggle for toggling a boolean customize setting VAR.<br>
The toggle function uses <code>customize-set-variable</code> to change the variable.
<var>othername</var> gives an alternative name than the default &lt;VAR&gt;-toggle.
The name of the defined function is returned.
</p></dd></dl>
<hr size="6">
<a name="Global-variables"></a>
<a name="SEC44"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC43" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC45" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC40" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 13.4 Global variables </h2>

<p>Global variables are defined in &lsquo;<tt>proof.el</tt>&rsquo;.  The same file defines
a few utility functions and some triggers to load in the other files.
</p>
<dl>
<dt><u>Variable:</u> <b>proof-script-buffer</b>
<a name="IDX158"></a>
</dt>
<dd><p>The currently active scripting buffer or nil if none.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-buffer</b>
<a name="IDX159"></a>
</dt>
<dd><p>Process buffer where the proof assistant is run.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-response-buffer</b>
<a name="IDX160"></a>
</dt>
<dd><p>The response buffer.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-goals-buffer</b>
<a name="IDX161"></a>
</dt>
<dd><p>The goals buffer.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-buffer-type</b>
<a name="IDX162"></a>
</dt>
<dd><p>Symbol for the type of this buffer: <code>'script</code>, <code>'shell</code>, <code>'goals</code>, or <code>'response</code>.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-included-files-list</b>
<a name="IDX163"></a>
</dt>
<dd><p>List of files currently included in proof process.<br>
This list contains files in canonical truename format
(see &lsquo;<samp><code>file-truename</code></samp>&rsquo;).
</p>
<p>Whenever a new file is being processed, it gets added to this list
via the <code>proof-shell-process-file</code> configuration settings.
When the prover retracts a file, this list is resynchronised via the
<code>proof-shell-retract-files-regexp</code> and <code>proof-shell-compute-new-files-list</code>
configuration settings.
</p>
<p>Only files which have been <strong>fully</strong> processed should be included here.
Proof General itself will automatically add the filenames of a script
buffer which has been completely read when scripting is deactivated.
It will automatically remove the filename of a script buffer which
is completely unread when scripting is deactivated.
</p>
<p>NB: Currently there is no generic provision for removing files which
are only partly read-in due to an error, so ideally the proof assistant
should only output a processed message when a file has been successfully
read.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-proof-completed</b>
<a name="IDX164"></a>
</dt>
<dd><p>Flag indicating that a completed proof has just been observed.<br>
If non-nil, the value counts the commands from the last command
of the proof (starting from 1).
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-error-or-interrupt-seen</b>
<a name="IDX165"></a>
</dt>
<dd><p>Flag indicating that an error or interrupt has just occurred.<br>
Set to <code>'error</code> or <code>'interrupt</code> if one was observed from the proof
assistant during the last group of commands.
</p></dd></dl>


<hr size="6">
<a name="Proof-script-mode"></a>
<a name="SEC45"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC44" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC46" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC40" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 13.5 Proof script mode </h2>

<p>The file &lsquo;<tt>proof-script.el</tt>&rsquo; contains the main code for proof script
mode, as well as definitions of menus, key-bindings, and user-level
functions.
</p>
<p>Proof scripts have two important variables for the locked and queue
regions.  These variables are local to each script buffer (although we
only really need one queue span in total rather than one per buffer).
</p>
<dl>
<dt><u>Variable:</u> <b>proof-locked-span</b>
<a name="IDX166"></a>
</dt>
<dd><p>The locked span of the buffer.<br>
Each script buffer has its own locked span, which may be detached
from the buffer.
Proof General allows buffers in other modes also to be locked;
these also have a non-nil value for this variable.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-queue-span</b>
<a name="IDX167"></a>
</dt>
<dd><p>The queue span of the buffer.  May be detached if inactive or empty.<br>
Each script buffer has its own queue span, although only the active
scripting buffer may have an active queue span.
</p></dd></dl>

<p>Various utility functions manipulate and examine the spans.  An
important one is <code>proof-init-segmentation</code>.
</p>
<dl>
<dt><u>Function:</u> <b>proof-init-segmentation</b>
<a name="IDX168"></a>
</dt>
<dd><p>Initialise the queue and locked spans in a proof script buffer.<br>
Allocate spans if need be.  The spans are detached from the
buffer, so the regions are made empty by this function.
Also clear list of script portions.
</p></dd></dl>

<p>For locking files loaded by a proof assistant, we use the next function.
</p>
<dl>
<dt><u>Function:</u> <b>proof-complete-buffer-atomic</b><i> buffer</i>
<a name="IDX169"></a>
</dt>
<dd><p>Make sure <var>buffer</var> is marked as completely processed, completing with a single step.
</p>
<p>If buffer already contains a locked region, only the remainder of the
buffer is closed off atomically.
</p>
<p>This works for buffers which are not in proof scripting mode too,
to allow other files loaded by proof assistants to be marked read-only.
</p></dd></dl>

<p>Atomic locking is instigated by the next function, which uses the
variables <code>proof-included-files-list</code> documented earlier
(see section <a href="PG-adapting_9.html#SEC31">Handling Multiple Files</a> and see section <a href="#SEC44">Global variables</a>).
</p>
<dl>
<dt><u>Function:</u> <b>proof-register-possibly-new-processed-file</b><i> file &amp;optional informprover noquestions</i>
<a name="IDX170"></a>
</dt>
<dd><p>Register a possibly new <var>file</var> as having been processed by the prover.
</p>
<p>If <var>informprover</var> is non-nil, the proof assistant will be told about this,
to co-ordinate with its internal file-management.  (Otherwise we assume
that it is a message from the proof assistant which triggers this call).
In this case, the user will be queried to save some buffers, unless
<var>noquestions</var> is non-nil.
</p>
<p>No action is taken if the file is already registered.
</p>
<p>A warning message is issued if the register request came from the
proof assistant and Emacs has a modified buffer visiting the file.
</p></dd></dl>

<p>An important pair of functions activate and deactivate scripting for the
current buffer.  A change in the state of active scripting can trigger
various actions, such as starting up the proof assistant, or altering
<code>proof-included-files-list</code>.
</p>
<dl>
<dt><u>Command:</u> <b>proof-activate-scripting</b><i> &amp;optional nosaves queuemode</i>
<a name="IDX171"></a>
</dt>
<dd><p>Ready prover and activate scripting for the current script buffer.
</p>
<p>The current buffer is prepared for scripting.  No changes are
necessary if it is already in Scripting minor mode.  Otherwise, it
will become the new active scripting buffer, provided scripting can be
switched off in the previous active scripting buffer with
&lsquo;<samp><code>proof-deactivate-scripting</code></samp>&rsquo;.
</p>
<p>Activating a new script buffer may be a good time to ask if the user
wants to save some buffers; this is done if the user option
&lsquo;<samp><code>proof-query-file-save-when-activating-scripting</code></samp>&rsquo; is set and provided
the optional argument <var>nosaves</var> is non-nil.
</p>
<p>The optional argument <var>queuemode</var> relaxes the test for a busy proof
shell to allow one which has mode <var>queuemode</var>.  In all other cases, a
proof shell busy error is given.
</p>
<p>Finally, the hooks &lsquo;<samp><code>proof-activate-scripting-hook</code></samp>&rsquo; are run.  This can
be a useful place to configure the proof assistant for scripting in a
particular file, for example, loading the correct theory, or whatever.
If the hooks issue commands to the proof assistant (via
&lsquo;<samp><code>proof-shell-invisible-command</code></samp>&rsquo;) which result in an error, the
activation is considered to have failed and an error is given.
</p></dd></dl>

<dl>
<dt><u>Command:</u> <b>proof-deactivate-scripting</b><i> &amp;optional forcedaction</i>
<a name="IDX172"></a>
</dt>
<dd><p>Deactivate scripting for the active scripting buffer.
</p>
<p>Set &lsquo;<samp><code>proof-script-buffer</code></samp>&rsquo; to nil and turn off the modeline indicator.
No action if there is no active scripting buffer.
</p>
<p>We make sure that the active scripting buffer either has no locked
region or a full locked region (everything in it has been processed).
If this is not already the case, we question the user whether to
retract or assert, or automatically take the action indicated in the
user option &lsquo;<samp><code>proof-auto-action-when-deactivating-scripting</code>.</samp>&rsquo;
</p>
<p>If the scripting buffer is (or has become) fully processed, and it is
associated with a file, it is registered on
&lsquo;<samp><code>proof-included-files-list</code></samp>&rsquo;.  Conversely, if it is (or has become)
empty, we make sure that it is <strong>not</strong> registered.  This is to be
certain that the included files list behaves as we might expect with
respect to the active scripting buffer, in an attempt to harmonize
mixed scripting and file reading in the prover.
</p>
<p>This function either succeeds, fails because the user refused to
process or retract a partly finished buffer, or gives an error message
because retraction or processing failed.  If this function succeeds,
then &lsquo;<samp><code>proof-script-buffer</code></samp>&rsquo; is nil afterwards.
</p>
<p>The optional argument <var>forcedaction</var> overrides the user option
&lsquo;<samp><code>proof-auto-action-when-deactivating-scripting</code></samp>&rsquo; and prevents
questioning the user.  It is used to make a value for
the &lsquo;<samp><code>kill-buffer-hook</code></samp>&rsquo; for scripting buffers, so that when
a scripting buffer is killed it is always retracted.
</p></dd></dl>

<p>The function <code>proof-segment-up-to</code> is the main one used for parsing
the proof script buffer.  There are several variants of this function
available corresponding to different parsing strategies; the appropriate
one is aliased to <code>proof-segment-up-to</code> according to which
configuration variables have been set.  If only
<code>proof-script-command-end-regexp</code> or <code>proof-terminal-char</code> are set,
then the default is <code>proof-segment-up-to-cmdend</code>.  If
<code>proof-script-command-start-regexp</code> is set, the choice is
<code>proof-segment-up-to-cmdstart</code>.  
</p>
<dl>
<dt><u>Function:</u> <b>proof-segment-up-to-cmdend</b><i> pos &amp;optional next-command-end</i>
<a name="IDX173"></a>
</dt>
<dd><p>Parse the script buffer from end of locked to <var>pos</var>.<br>
Return a list of (type, string, int) tuples.
</p>
<p>Each tuple denotes the command and the position of its terminator,
type is one of <code>'comment</code>, or <code>'cmd</code>.  <code>'unclosed-comment</code> may be consed onto
the start if the segment finishes with an unclosed comment.
</p>
<p>If optional <var>next-command-end</var> is non-nil, we include the command
which continues past <var>pos</var>, if any.
</p>
<p>This version is used when &lsquo;<samp><code>proof-script-command-end-regexp</code></samp>&rsquo; is set.
</p></dd></dl>

<dl>
<dt><u>Function:</u> <b>proof-segment-up-to-cmdstart</b><i> pos &amp;optional next-command-end</i>
<a name="IDX174"></a>
</dt>
<dd><p>Parse the script buffer from end of locked to <var>pos</var>.<br>
Return a list of (type, string, int) tuples.
</p>
<p>Each tuple denotes the command and the position of its terminator,
type is one of <code>'comment</code>, or <code>'cmd</code>.
</p>
<p>If optional <var>next-command-end</var> is non-nil, we include the command
which continues past <var>pos</var>, if any.  (NOT <var>implemented</var> IN <var>this</var> <var>version</var>).
</p>
<p>This version is used when &lsquo;<samp><code>proof-script-command-start-regexp</code></samp>&rsquo; is set.
</p></dd></dl>


<p>The function <code>proof-semis-to-vanillas</code> is used to convert
a parsed region of the script into a series of commands to
be sent to the proof assistant.
</p>
<dl>
<dt><u>Function:</u> <b>proof-semis-to-vanillas</b><i> semis &amp;optional callback-fn</i>
<a name="IDX175"></a>
</dt>
<dd><p>Convert a sequence of terminator positions to a set of vanilla extents.<br>
Proof terminator positions <var>semis</var> has the form returned by
the function proof-segment-up-to.
Set the callback to <var>callback-fn</var> or <code>'proof-done-advancing</code> by default.
</p></dd></dl>

<p>The function <code>proof-assert-until-point</code> is the main one used to
process commands in the script buffer.  It's actually used to implement
the assert-until-point, electric terminator keypress, and
find-next-terminator behaviours.  In different cases we want different
things, but usually the information (i.e. are we inside a comment) isn't
available until we've actually run <code>proof-segment-up-to (point)</code>,
hence all the different options when we've done so.
</p>
<dl>
<dt><u>Function:</u> <b>proof-assert-until-point</b><i> &amp;optional unclosed-comment-fun ignore-proof-process-p</i>
<a name="IDX176"></a>
</dt>
<dd><p>Process the region from the end of the locked-region until point.<br>
Default action if inside a comment is just process as far as the start of
the comment.
</p>
<p>If you want something different, put it inside
<var>unclosed-comment-fun</var>.  If <var>ignore-proof-process-p</var> is set, no commands
will be added to the queue and the buffer will not be activated for
scripting.
</p></dd></dl>

<p><code>proof-assert-next-command</code> is a variant of this function.
</p>
<dl>
<dt><u>Command:</u> <b>proof-assert-next-command</b><i> &amp;optional unclosed-comment-fun ignore-proof-process-p dont-move-forward for-new-command</i>
<a name="IDX177"></a>
</dt>
<dd><p>Process until the end of the next unprocessed command after point.<br>
If inside a comment, just process until the start of the comment.
</p>
<p>If you want something different, put it inside <var>unclosed-comment-fun</var>.
If <var>ignore-proof-process-p</var> is set, no commands will be added to the queue.
Afterwards, move forward to near the next command afterwards, unless
<var>dont-move-forward</var> is non-nil.  If <var>for-new-command</var> is non-nil,
a space or newline will be inserted automatically.
</p></dd></dl>

<p>The main command for retracting parts of a script is
<code>proof-retract-until-point</code>.
</p>
<dl>
<dt><u>Function:</u> <b>proof-retract-until-point</b><i> &amp;optional delete-region</i>
<a name="IDX178"></a>
</dt>
<dd><p>Set up the proof process for retracting until point.<br>
In particular, set a flag for the filter process to call
&lsquo;<samp><code>proof-done-retracting</code></samp>&rsquo; after the proof process has successfully
reset its state.
If <var>delete-region</var> is non-nil, delete the region in the proof script
corresponding to the proof command sequence.
If invoked outside a locked region, undo the last successfully processed
command.
</p></dd></dl>

<p>To clean up when scripting is stopped, a script buffer is killed, or the
proof assistant exits, we use the functions
<code>proof-restart-buffers</code> and
<code>proof-script-remove-all-spans-and-deactivate</code>.
</p>
<dl>
<dt><u>Function:</u> <b>proof-restart-buffers</b><i> buffers</i>
<a name="IDX179"></a>
</dt>
<dd><p>Remove all extents in <var>buffers</var> and maybe reset &lsquo;<samp><code>proof-script-buffer</code></samp>&rsquo;.<br>
No effect on a buffer which is nil or killed.  If one of the buffers
is the current scripting buffer, then &lsquo;<samp><code>proof-script-buffer</code></samp>&rsquo;
will deactivated.
</p></dd></dl>

<dl>
<dt><u>Function:</u> <b>proof-script-remove-all-spans-and-deactivate</b>
<a name="IDX180"></a>
</dt>
<dd><p>Remove all spans from scripting buffers via <code>proof-restart-buffers</code>.
</p></dd></dl>


<hr size="6">
<a name="Proof-shell-mode"></a>
<a name="SEC46"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC45" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC47" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC40" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 13.6 Proof shell mode </h2>

<p>The proof shell mode code is in the file &lsquo;<tt>proof-shell.el</tt>&rsquo;.  Proof
shell mode is defined to inherit from <code>comint-mode</code> using
<code>define-derived-mode</code> near the end of the file.  The bulk of the
code in the file is concerned with sending code to and from the shell,
and processing output for the associated buffers (goals and response).
</p>
<p>Good process handling is a tricky issue.  Proof General attempts to
manage the process strictly, by maintaining a queue of commands to send
to the process.  Once a command has been processed, another one is
popped off the queue and sent.
</p>
<p>There are several important internal variables which control
interaction with the process.
</p>
<dl>
<dt><u>Variable:</u> <b>proof-shell-busy</b>
<a name="IDX181"></a>
</dt>
<dd><p>A lock indicating that the proof shell is processing.<br>
When this is non-nil, <code>proof-shell-ready-prover</code> will give
an error.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-marker</b>
<a name="IDX182"></a>
</dt>
<dd><p>Marker in proof shell buffer pointing to previous command input.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-action-list</b>
<a name="IDX183"></a>
</dt>
<dd><p>A list of<br>
</p><table><tr><td>&nbsp;</td><td><pre class="lisp">  (<var>span</var> <var>command</var> <var>action</var>)
</pre></td></tr></table>
<p>triples, which is a queue of things to do.
See the functions &lsquo;<samp><code>proof-start-queue</code></samp>&rsquo; and &lsquo;<samp>proof-exec-loop</samp>&rsquo;.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>pg-subterm-anns-use-stack</b>
<a name="IDX184"></a>
</dt>
<dd><p>Choice of syntax tree encoding for terms.
</p>
<p>If nil, prover is expected to make no optimisations.
If non-nil, the pretty printer of the prover only reports local changes.
For <var>lego</var> 1.3.1 use nil, for Coq 6.2, use t.
</p></dd></dl>


<p>The function <code>proof-shell-start</code> is used to initialise a shell
buffer and the associated buffers.  
</p>
<dl>
<dt><u>Command:</u> <b>proof-shell-start</b>
<a name="IDX185"></a>
</dt>
<dd><p>Initialise a shell-like buffer for a proof assistant.
</p>
<p>Also generates goal and response buffers.
Does nothing if proof assistant is already running.
</p></dd></dl>

<p>The function <code>proof-shell-kill-function</code> performs the converse
function of shutting things down; it is used as a hook function for
<code>kill-buffer-hook</code>.  Then no harm occurs if the user kills the
shell directly, or if it is done more cautiously via
<code>proof-shell-exit</code>.  The function <code>proof-shell-restart</code> allows
a less drastic way of restarting scripting, other than killing and
restarting the process.
</p>
<dl>
<dt><u>Function:</u> <b>proof-shell-kill-function</b>
<a name="IDX186"></a>
</dt>
<dd><p>Function run when a proof-shell buffer is killed.<br>
Try to shut down the proof process nicely and clear locked
regions and state variables.  Value for &lsquo;<samp><code>kill-buffer-hook</code></samp>&rsquo; in
shell buffer, alled by &lsquo;<samp><code>proof-shell-bail-out</code></samp>&rsquo; if process exits.
</p></dd></dl>

<dl>
<dt><u>Command:</u> <b>proof-shell-exit</b>
<a name="IDX187"></a>
</dt>
<dd><p>Query the user and exit the proof process.
</p>
<p>This simply kills the &lsquo;<samp><code>proof-shell-buffer</code></samp>&rsquo; relying on the hook function
&lsquo;<samp><code>proof-shell-kill-function</code></samp>&rsquo; to do the hard work.
</p></dd></dl>

<dl>
<dt><u>Function:</u> <b>proof-shell-bail-out</b><i> process event</i>
<a name="IDX188"></a>
</dt>
<dd><p>Value for the process sentinel for the proof assistant process.<br>
If the proof assistant dies, run <code>proof-shell-kill-function</code> to
cleanup and remove the associated buffers.  The shell buffer is
left around so the user may discover what killed the process.
</p></dd></dl>

<dl>
<dt><u>Command:</u> <b>proof-shell-restart</b>
<a name="IDX189"></a>
</dt>
<dd><p>Clear script buffers and send &lsquo;<samp><code>proof-shell-restart-cmd</code></samp>&rsquo;.<br>
All locked regions are cleared and the active scripting buffer
deactivated.  
</p>
<p>If the proof shell is busy, an interrupt is sent with
&lsquo;<samp><code>proof-interrupt-process</code></samp>&rsquo; and we wait until the process is ready.
</p>
<p>The restart command should re-synchronize Proof General with the proof
assistant, without actually exiting and restarting the proof assistant
process.
</p>
<p>It is up to the proof assistant how much context is cleared: for
example, theories already loaded may be &quot;cached&quot; in some way,
so that loading them the next time round only performs a re-linking
operation, not full re-processing.  (One way of caching is via
object files, used by Lego and Coq).
</p></dd></dl>

<hr size="6">
<a name="SEC47"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC46" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC48" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC46" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h3 class="subsection"> 13.6.1 Input to the shell </h3>

<p>Input to the proof shell via the queue region is managed by the
functions <code>proof-start-queue</code> and <code>proof-shell-exec-loop</code>.
</p>
<dl>
<dt><u>Function:</u> <b>proof-start-queue</b><i> start end alist</i>
<a name="IDX190"></a>
</dt>
<dd><p>Begin processing a queue of commands in <var>alist</var>.<br>
If <var>start</var> is non-nil, <var>start</var> and <var>end</var> are buffer positions in the
active scripting buffer for the queue region.
</p>
<p>This function calls &lsquo;<samp><code>proof-append-alist</code></samp>&rsquo;.
</p></dd></dl>

<dl>
<dt><u>Function:</u> <b>proof-append-alist</b><i> alist &amp;optional queuemode</i>
<a name="IDX191"></a>
</dt>
<dd><p>Chop off the vacuous prefix of the command queue <var>alist</var> and queue it.<br>
For each &lsquo;<samp><code>proof-no-command</code></samp>&rsquo; item at the head of the list, invoke its 
callback and remove it from the list.
</p>
<p>Append the result onto &lsquo;<samp><code>proof-action-list</code></samp>&rsquo;, and if the proof 
shell isn't already busy, grab the lock with <var>queuemode</var> and
start processing the queue.
</p>
<p>If the proof shell is busy when this function is called,
then <var>queuemode</var> must match the mode of the queue currently
being processed.
</p></dd></dl>

<a name="IDX192"></a>
<dl>
<dt><u>Function:</u> <b>proof-shell-exec-loop</b>
<a name="IDX193"></a>
</dt>
<dd><p>Process the &lsquo;<samp><code>proof-action-list</code></samp>&rsquo;.
</p>
<p>&lsquo;<samp><code>proof-action-list</code></samp>&rsquo; contains a list of (<var>span</var> <var>command</var> <var>action</var>) triples.
</p>
<p>If this function is called with a non-empty <code>proof-action-list</code>, the
head of the list is the previously executed command which succeeded.
We execute (<var>action</var> <var>span</var>) on the first item, then (<var>action</var> <var>span</var>) on any
following items which have &lsquo;<samp><code>proof-no-command</code></samp>&rsquo; as their cmd components.
If a there is a next command after that, send it to the process.  If
the action list becomes empty, unlock the process and remove the queue
region.
</p>
<p>The return value is non-nil if the action list is now empty.
</p></dd></dl>

<p>Input is actually inserted into the shell buffer and sent to the process
by the low-level function <code>proof-shell-insert</code>.  
</p>
<dl>
<dt><u>Function:</u> <b>proof-shell-insert</b><i> string action</i>
<a name="IDX194"></a>
</dt>
<dd><p>Insert <var>string</var> at the end of the proof shell, call &lsquo;<samp><code>comint-send-input</code></samp>&rsquo;.
</p>
<p>First call &lsquo;<samp><code>proof-shell-insert-hook</code></samp>&rsquo;.  The argument <var>action</var> may be
examined by the hook to determine how to process the <var>string</var> variable.
NB: the hook is not called for the empty (null) string.
</p>
<p>Then strip <var>string</var> of carriage returns before inserting it and updating
&lsquo;<samp><code>proof-marker</code></samp>&rsquo; to point to the end of the newly inserted text.
</p>
<p>Do not use this function directly, or output will be lost.  It is only
used in &lsquo;<samp><code>proof-append-alist</code></samp>&rsquo; when we start processing a queue, and in
&lsquo;<samp><code>proof-shell-exec-loop</code></samp>&rsquo;, to process the next item.
</p></dd></dl>


<p>When Proof General is processing a queue of commands, the lock
is managed using a couple of utility functions.  You should
not need to use these directly.
</p>

<dl>
<dt><u>Function:</u> <b>proof-grab-lock</b><i> &amp;optional queuemode</i>
<a name="IDX195"></a>
</dt>
<dd><p>Grab the proof shell lock, starting the proof assistant if need be.<br>
Runs &lsquo;<samp><code>proof-state-change-hook</code></samp>&rsquo; to notify state change.
Clears the &lsquo;<samp><code>proof-shell-error-or-interrupt-seen</code></samp>&rsquo; flag.
If <var>queuemode</var> is supplied, set the lock to that value.
</p></dd></dl>

<dl>
<dt><u>Function:</u> <b>proof-release-lock</b><i> &amp;optional err-or-int</i>
<a name="IDX196"></a>
</dt>
<dd><p>Release the proof shell lock, with error or interrupt flag <var>err-or-int</var>.<br>
Clear &lsquo;<samp><code>proof-shell-busy</code></samp>&rsquo;, and set &lsquo;<samp><code>proof-shell-error-or-interrupt-seen</code></samp>&rsquo;
to err-or-int.
</p></dd></dl>


<hr size="6">
<a name="SEC48"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC47" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC49" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC46" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h3 class="subsection"> 13.6.2 Output from the shell </h3>

<p>Two main functions deal with output, <code>proof-shell-process-output</code>
and <code>proof-shell-process-urgent-message</code>.  In effect we consider
the output to be two streams intermingled: the &quot;urgent&quot; messages which
have &quot;eager&quot; annotations, as well as the ordinary ruminations from the
prover.  
</p>
<p>The idea is to conceal as much irrelevant information from the user as
possible; only the remaining output between prompts and after the last
urgent message will be a candidate for the goal or response buffer.  The
internal variable <code>proof-shell-urgent-message-marker</code> tracks the
last urgent message seen.
</p>
<p>When output is grabbed from the prover process, the first action
is to strip spurious carriage return characters from the end of 
lines, if <code>proof-shell-strip-crs-from-output</code> requires it.
Then the output is stored into
<code>proof-shell-last-output</code>, and its type is stored in
<code>proof-shell-last-output-kind</code>.  Output which is deferred or
possibly discarded until the queue is empty is copied into
<code>proof-shell-delayed-output</code>, with type
<code>proof-shell-delayed-output-kind</code>.  A record of the last prompt
seen from the prover process is also kept, in
<code>proof-shell-last-prompt</code>.
</p>

<dl>
<dt><u>Variable:</u> <b>proof-shell-strip-crs-from-output</b>
<a name="IDX197"></a>
</dt>
<dd><p>If non-nil, remove carriage returns (^M) at the end of lines from output.<br>
This is enabled for cygwin32 systems by default.  You should turn it off
if you don't need it (slight speed penalty).
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-last-prompt</b>
<a name="IDX198"></a>
</dt>
<dd><p>A raw record of the last prompt seen from the proof system.<br>
This is the string matched by &lsquo;<samp><code>proof-shell-annotated-prompt-regexp</code></samp>&rsquo;.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-last-output</b>
<a name="IDX199"></a>
</dt>
<dd><p>A record of the last string seen from the proof system.<br>
This is raw string, for internal use only.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-last-output-kind</b>
<a name="IDX200"></a>
</dt>
<dd><p>A symbol denoting the type of the last output string from the proof system.<br>
Specifically:
</p><table><tr><td>&nbsp;</td><td><pre class="lisp"> <code>'interrupt</code>      An interrupt message
 <code>'error</code>          An error message
 <code>'abort</code>          A proof abort message
 <code>'loopback</code>       A command sent from the PA to be inserted into the script
 <code>'response</code>       A response message
 <code>'goals</code>          A goals (proof state) display
 <code>'systemspecific</code> Something specific to a particular system,
                  -- see &lsquo;<samp><code>proof-shell-process-output-system-specific</code></samp>&rsquo;
</pre></td></tr></table>
<p>The output corresponding to this will be in <code>proof-shell-last-output</code>.
</p>
<p>See also &lsquo;<samp><code>proof-shell-proof-completed</code></samp>&rsquo; for further information about
the proof process output, when ends of proofs are spotted.
</p>
<p>This variable can be used for instance specific functions which want
to examine <code>proof-shell-last-output</code>.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-delayed-output</b>
<a name="IDX201"></a>
</dt>
<dd><p>A copy of <code>proof-shell-last-output</code> held back for processing at end of queue.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-delayed-output-kind</b>
<a name="IDX202"></a>
</dt>
<dd><p>A copy of proof-shell-last-output-lind held back for processing at end of queue.
</p></dd></dl>
<a name="IDX203"></a>

<dl>
<dt><u>Function:</u> <b>proof-shell-process-output</b><i> cmd string</i>
<a name="IDX204"></a>
</dt>
<dd><p>Process shell output (resulting from <var>cmd</var>) by matching on <var>string</var>.<br>
<var>cmd</var> is the first part of the &lsquo;<samp><code>proof-action-list</code></samp>&rsquo; that lead to this
output.  The result of this function is a pair (<var>symbol</var> <var>newstring</var>).
</p>
<p>Here is where we recognizes interrupts, abortions of proofs, errors,
completions of proofs, and proof step hints (proof by pointing results).
They are checked for in this order, using
</p><table><tr><td>&nbsp;</td><td><pre class="lisp"> 
  &lsquo;<samp><code>proof-shell-interrupt-regexp</code></samp>&rsquo;
  &lsquo;<samp><code>proof-shell-error-regexp</code></samp>&rsquo;
  &lsquo;<samp><code>proof-shell-abort-goal-regexp</code></samp>&rsquo;
  &lsquo;<samp><code>proof-shell-proof-completed-regexp</code></samp>&rsquo;
  &lsquo;<samp><code>proof-shell-result-start</code></samp>&rsquo;
</pre></td></tr></table>
<p>All other output from the proof engine will be reported to the user in
the response buffer by setting &lsquo;<samp><code>proof-shell-delayed-output</code></samp>&rsquo; to a cons
cell of ('insert . <var>text</var>) where <var>text</var> is the text string to be inserted.
</p>
<p>Order of testing is: interrupt, abort, error, completion.
</p>
<p>To extend this function, set &lsquo;<samp><code>proof-shell-process-output-system-specific</code></samp>&rsquo;.
</p>
<p>The &quot;aborted&quot; case is intended for killing off an open proof during
retraction.  Typically it matches the message caused by a
&lsquo;<samp><code>proof-kill-goal-command</code></samp>&rsquo;.  It simply inserts the word &quot;Aborted&quot; into
the response buffer.  So it is expected to be the result of a 
retraction, rather than the indication that one should be made.
</p>
<p>This function sets &lsquo;<samp><code>proof-shell-last-output</code></samp>&rsquo; and &lsquo;<samp><code>proof-shell-last-output-kind</code></samp>&rsquo;,
which see.
</p></dd></dl>

<dl>
<dt><u>Variable:</u> <b>proof-shell-urgent-message-marker</b>
<a name="IDX205"></a>
</dt>
<dd><p>Marker in proof shell buffer pointing to end of last urgent message.
</p></dd></dl>

<dl>
<dt><u>Function:</u> <b>proof-shell-process-urgent-message</b><i> message</i>
<a name="IDX206"></a>
</dt>
<dd><p>Analyse urgent <var>message</var> for various cases.<br>
Cases are: included file, retracted file, cleared response buffer, 
variable setting or dependency list. 
If none of these apply, display <var>message</var>.
</p>
<p><var>message</var> should be a string annotated with 
&lsquo;<samp><code>proof-shell-eager-annotation-start</code></samp>&rsquo;, &lsquo;<samp><code>proof-shell-eager-annotation-end</code></samp>&rsquo;.
</p></dd></dl>

<p>The main processing point which triggers other actions is
<code>proof-shell-filter</code>.
</p>
<dl>
<dt><u>Function:</u> <b>proof-shell-filter</b><i> str</i>
<a name="IDX207"></a>
</dt>
<dd><p>Filter for the proof assistant shell-process.<br>
A function for &lsquo;<samp><code>comint-output-filter-functions</code></samp>&rsquo;.
</p>
<p>Deal with output and issue new input from the queue.
</p>
<p>Handle urgent messages first.  As many as possible are processed,
using the function &lsquo;<samp><code>proof-shell-process-urgent-messages</code></samp>&rsquo;.
</p>
<p>Otherwise wait until an annotated prompt appears in the input.  
If &lsquo;<samp><code>proof-shell-wakeup-char</code></samp>&rsquo; is set, wait until we see that in the
output chunk <var>str</var>.  This optimizes the filter a little bit.
</p>
<p>If a prompt is seen, run &lsquo;<samp><code>proof-shell-process-output</code></samp>&rsquo; on the output
between the new prompt and the last input (position of &lsquo;<samp><code>proof-marker</code></samp>&rsquo;)
or the last urgent message (position of
&lsquo;<samp><code>proof-shell-urgent-message-marker</code></samp>&rsquo;), whichever is later.
For example, in this case:
</p><table><tr><td>&nbsp;</td><td><pre class="lisp"> PROMPT&gt; <var>input</var>
 <var>output-1</var>
 <var>urgent-message</var>
 <var>output-2</var>
 PROMPT&gt;
</pre></td></tr></table>
<p>&lsquo;<samp><code>proof-marker</code></samp>&rsquo; is set after <var>input</var> by &lsquo;<samp><code>proof-shell-insert</code></samp>&rsquo; and
&lsquo;<samp><code>proof-shell-urgent-message-marker</code></samp>&rsquo; is set after <var>urgent-message</var>.
Only <var>output-2</var> will be processed.  For this reason, error
messages and interrupt messages should <strong>not</strong> be considered
urgent messages.
</p>
<p>Output is processed using the function
&lsquo;<samp><code>proof-shell-filter-process-output</code></samp>&rsquo;.
</p>
<p>The first time that a prompt is seen, &lsquo;<samp><code>proof-marker</code></samp>&rsquo; is
initialised to the end of the prompt.  This should
correspond with initializing the process.  The 
ordinary output before the first prompt is ignored (urgent messages, 
however, are always processed; hence their name).
</p></dd></dl>

<dl>
<dt><u>Function:</u> <b>proof-shell-filter-process-output</b><i> string</i>
<a name="IDX208"></a>
</dt>
<dd><p>Subroutine of &lsquo;<samp><code>proof-shell-filter</code></samp>&rsquo; to process output <var>string</var>.
</p>
<p>Appropriate action is taken depending on what
&lsquo;<samp><code>proof-shell-process-output</code></samp>&rsquo; returns: maybe handle an interrupt, an
error, or deal with ordinary output which is a candidate for the goal
or response buffer.  Ordinary output is only displayed when the proof
action list becomes empty, to avoid a confusing rapidly changing
output.
</p>
<p>After processing the current output, the last step undertaken
by the filter is to send the next command from the queue.
</p></dd></dl>






<hr size="6">
<a name="Debugging"></a>
<a name="SEC49"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC48" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC40" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 13.7 Debugging </h2>


<p>To debug Proof General, it may be helpful to set the
configuration variable <code>proof-general-debug</code>.
</p>
<dl>
<dt><u>User Option:</u> <b>proof-general-debug</b>
<a name="IDX209"></a>
</dt>
<dd><p>Non-nil to run Proof General in debug mode.<br>
This changes some behaviour (e.g. markup stripping) and displays
debugging messages in the response buffer.  To avoid erasing
messages shortly after they're printed, set &lsquo;<samp><code>proof-tidy-response</code></samp>&rsquo; to nil.
This is only useful for PG developers.
</p>
<p>The default value is <code>nil</code>.
</p></dd></dl>

<p>For more information about debugging Emacs lisp, consult the Emacs Lisp
Reference Manual.  I recommend using the source-level debugger
<code>edebug</code>.
</p>













<hr size="6">
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC40" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_15.html#SEC50" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="PG-adapting.html#SEC_Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_17.html#SEC57" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="PG-adapting_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<p>
 <font size="-1">
  This document was generated by <em>David Aspinall</em> on <em>July, 24 2008</em> using <a href="http://www.nongnu.org/texi2html/"><em>texi2html 1.78</em></a>.
 </font>
 <br>

</p>
</body>
</html>
